name: Post-Merge Deployment Workflow
run-name: ${{ github.actor }}s commit is being deployed!
on:
  push:
    branches:
    - main
    # test branch deployment
    # - ra-dashboard 

jobs:

  # #################################################
  # Deploy to Beta Stage
  # #################################################

  Deploy-To-Beta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3

      - name: Set up node 18.16
        uses: actions/setup-node@v3
        with:
          node-version: 18.16.0

      # Needed for API Autogenerator
      - name: Setup Java 20
        uses: actions/setup-java@v3
        with:
          distribution: corretto
          java-version: 20

      - name: Build autogenerated api client
        working-directory: ./api_definition
        run: npm install && npm run build

      - name: Build website webpack bundle
        working-directory: ./website
        run: npm install && npm run build

      - name: Build cloudformation template
        working-directory: ./cloud_formation
        run: npm install && npm run build

        # We install cdk ourselves instead of using an existing github action for cdk cli
        # commands because all are owned by non-trusted sources, and could be updated to
        # leak our credentials.
      - name: Globally install CDK
        run: npm install -g aws-cdk@2.82.0

      - name: Deploy environment
        working-directory: ./cloud_formation
        run: cdk bootstrap && cdk deploy --require-approval never
        env:
          # AWS access keys with permission to deploy to cloud formation.
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          # AWS Deployment Account and Configurations
          AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: us-west-2
          AWS_STAGE: beta

  # #################################################
  # Integration Tests
  # #################################################

  Integration-Test:
    runs-on: ubuntu-latest
    needs: Deploy-To-Beta
    steps:
      - run: echo "Placeholder"

  # #################################################
  # Deploy to Prod Stage
  # #################################################

  Deploy-To-Prod:
    runs-on: ubuntu-latest
    needs: Integration-Test
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3

      - name: Set up node 18.16
        uses: actions/setup-node@v3
        with:
          node-version: 18.16.0

      # Needed for API Autogenerator
      - name: Setup Java 20
        uses: actions/setup-java@v3
        with:
          distribution: corretto
          java-version: 20

      - name: Build autogenerated api client
        working-directory: ./api_definition
        run: npm install && npm run build

      - name: Build website webpack bundle
        working-directory: ./website
        run: npm install && npm run build

      - name: Build cloudformation template
        working-directory: ./cloud_formation
        run: npm install && npm run build

        # We install cdk ourselves instead of using an existing github action for cdk cli
        # commands because all are owned by non-trusted sources, and could be updated to
        # leak our credentials.
      - name: Globally install CDK
        run: npm install -g aws-cdk@2.82.0

      - name: Deploy environment
        working-directory: ./cloud_formation
        run: cdk bootstrap && cdk deploy --require-approval never
        env:
          # AWS access keys with permission to deploy to cloud formation.
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

          # AWS Deployment Account and Configurations
          AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: us-east-1
          AWS_STAGE: prod
